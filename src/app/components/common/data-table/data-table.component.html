<ng-container *ngIf="showColumnToggles">
  <ng-container *ngIf="columnToggleSlot; else defaultTogglePanel">
    <ng-container *ngTemplateOutlet="columnToggleSlot"></ng-container>
  </ng-container>

  <ng-template #defaultTogglePanel>
    <div class="column-toggles">
      @for (col of columns; track $index) {
        <app-checkbox [(ngModel)]="col.visible" (change)="saveColumnVisibility()" [label]="col.header"></app-checkbox>
      }

      <app-button type="button" variant="solid" size="sm" color="primary" (click)="resetColumnVisibility()"
        >Reset</app-button
      >
    </div>
  </ng-template>
</ng-container>

<div class="column-toggle-dropdown" #dropdown>
  <button type="button" (click)="toggleDropdown()" aria-haspopup="true" [attr.aria-expanded]="dropdownOpen">
    Columns ▼
  </button>

  <div class="menu" *ngIf="dropdownOpen" role="menu">
    <button type="button" (click)="showAllColumns()" class="action-btn">Show All</button>
    <button type="button" (click)="hideAllColumns()" class="action-btn">Hide All</button>
    <div class="columns-list">
      @for (col of columns; track $index) {
        <div>
          <app-checkbox
            [(ngModel)]="col.visible"
            (change)="saveColumnVisibility()"
            [ariaChecked]="col.visible !== false"
            [label]="col.header"
          ></app-checkbox>
        </div>
      }
    </div>
  </div>
</div>

<div class="filter-chips" *ngIf="hasActiveFilters()">
  <ng-container *ngFor="let filterKey of getActiveFilterKeys()">
    <ng-container
      *ngIf="filters[filterKey] !== '' && filters[filterKey] !== undefined && filters[filterKey]?.length !== 0"
    >
      <!-- Single-value filter -->
      <span class="filter-chip" *ngIf="!isMultiSelectFilter(filterKey)">
        {{ getColumnHeader(filterKey) }}: {{ filters[filterKey] }}
        <button (click)="clearFilter(filterKey)" aria-label="Remove filter">×</button>
      </span>

      <!-- Multi-select filter -->
      <span class="filter-chip" *ngIf="isMultiSelectFilter(filterKey)">
        {{ getColumnHeader(filterKey) }}:
        <ng-container *ngFor="let val of getFilterArray(filterKey)">
          <span class="chip">
            {{ getOptionLabel(filterKey, val) }}
            <button (click)="removeMultiSelectFilter(filterKey, val)" aria-label="Remove filter">×</button>
          </span>
        </ng-container>
      </span>
    </ng-container>
  </ng-container>

  <button class="clear-all-btn" (click)="clearAllFilters()">Clear All</button>
</div>

<ng-container *ngIf="loading; else tableContent">
  <ng-content select="[loading-template]"></ng-content>
  <div class="table-loading-default" *ngIf="!hasLoadingSlot"><span class="spinner"></span> Loading...</div>
</ng-container>

<ng-template #tableContent>
  <div class="table-outer-wrapper">
    <div class="table-wrapper">
      <table class="custom-table">
        <thead [class.sticky-header]="stickyHeader">
          <tr>
            <th *ngIf="rowTemplate" class="expand-cell-header"></th>
            <th
              [class.sticky-column]="stickyColumn && col.fixed"
              *ngFor="let col of visibleColumns"
              (click)="col.sortable && toggleSort(col.field)"
            >
              {{ col.header }}
              <span *ngIf="col.sortable && sortColumn() === col.field">
                {{ sortAsc() ? "▲" : "▼" }}
              </span>
            </th>
            <th *ngIf="actionsTemplate">Actions</th>
          </tr>
          <tr class="filter-row" *ngIf="hasFilterableColumns">
            <th></th>
            <th *ngFor="let col of visibleColumns">
              <ng-container *ngIf="col.filterable" [ngSwitch]="col.filterType || 'text'">
                <!-- Text Filter -->
                <input
                  *ngSwitchCase="'text'"
                  type="text"
                  [placeholder]="col.placeholder || 'Filter...'"
                  [value]="filters[col.field] || ''"
                  (input)="handleInput($event, col.field)"
                />

                <!-- Single Select -->
                <select
                  *ngSwitchCase="'select'"
                  [value]="filters[col.field] || ''"
                  (change)="handleSelectInput($event, col.field, false)"
                >
                  <option value="">-- All --</option>
                  <option *ngFor="let opt of col.filterOptions" [value]="opt.value">
                    {{ opt.label }}
                  </option>
                </select>

                <!-- Multi Select -->
                <select *ngSwitchCase="'multi-select'" multiple (change)="handleSelectInput($event, col.field, true)">
                  <option
                    *ngFor="let opt of col.filterOptions"
                    [value]="opt.value"
                    [selected]="filters[col.field]?.includes(opt.value)"
                  >
                    {{ opt.label }}
                  </option>
                </select>
              </ng-container>
            </th>
          </tr>
        </thead>

        <tbody>
          <ng-container *ngFor="let row of data; let rowIndex = index">
            <tr>
              <td class="expand-cell">
                <button
                  type="button"
                  (click)="toggleRow(rowIndex); $event.stopPropagation()"
                  class="expand-btn"
                  [attr.aria-expanded]="expandedRows.has(rowIndex)"
                  aria-label="Toggle Row"
                >
                  <span class="chevron" [class.expanded]="expandedRows.has(rowIndex)">▸</span>
                </button>
              </td>
              <td [class.sticky-column]="stickyColumn && col.fixed" *ngFor="let col of visibleColumns">
                <ng-container *ngIf="!col.template; else custom">
                  {{ row[col.field] }}
                </ng-container>
                <ng-template #custom>
                  <ng-container
                    *ngTemplateOutlet="col.template ?? null; context: { $implicit: row[col.field], row: row }"
                  ></ng-container>
                </ng-template>
              </td>
              <td *ngIf="actionsTemplate">
                <ng-container *ngTemplateOutlet="actionsTemplate; context: { row: row }"></ng-container>
              </td>
            </tr>

            <!-- Inner Row -->
            <tr *ngIf="expandedRows.has(rowIndex)">
              <td [attr.colspan]="visibleColumns.length" class="inner-row-cell">
                <ng-container *ngTemplateOutlet="rowTemplate ?? null; context: { $implicit: row }"></ng-container>
              </td>
            </tr>
          </ng-container>
        </tbody>

        <tfoot>
          <tr>
            <td [colSpan]="visibleColumns.length + 2">
              <app-paginator [totalItems]="total" [showPageSizeSelector]="false" (pageChange)="onPageChange($event)">
              </app-paginator>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</ng-template>
